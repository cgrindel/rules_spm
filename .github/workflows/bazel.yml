name: Build

on:
  pull_request:
    branches: [ main ]

jobs:
  macos_build:

    runs-on: macos-11.0

    steps:
    - uses: actions/checkout@v2

    - name: Write local.bazelrc File
      shell: bash
      run: |
        cat >local.bazelrc <<EOF
        common --config=ci
        EOF

    - name: Output the Bazel Info
      shell: bash
      run: |
        bazelisk info

    - name: Execute Tests
      shell: bash
      run: |
        bazelisk test //... 

    - name: Build Anything Not Tested
      shell: bash
      run: |
        bazelisk build //... 

    - name: Test Simple Example
      shell: bash
      run: |
        cd examples/simple
        bazelisk test //...

    - name: Test Package With Shared Deps Example
      shell: bash
      run: |
        cd examples/package_with_shared_deps
        bazelisk test //...

    - name: Test Vapor Example
      shell: bash
      run: |
        cd examples/vapor
        bazelisk test //...

    - name: Test iOS Simulator Example
      shell: bash
      run: |
        cd examples/ios_sim
        bazelisk test //...

  ubuntu_build:

    runs-on: ubuntu-20.04

    env:
      CC: clang

    steps:
    - uses: actions/checkout@v2


    - name: Write local.bazelrc File
      shell: bash
      run: |
        cat >local.bazelrc <<EOF
        common --config=ci
        EOF

    - name: Bazel Config for Linux
      shell: bash
      run: |
        # Find the actual Swift bin directory. Make sure that this appears
        # first in the PATH that is used by the actions.
        swift_exec=$(which swift)
        real_swift_exec=$(realpath $swift_exec)
        real_swift_dir=$(dirname $real_swift_exec)
        new_path="${real_swift_dir}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        cat >>local.bazelrc <<EOF
        build --action_env=PATH=${new_path}
        EOF

    - name: Output the Bazel Info
      shell: bash
      run: |
        bazelisk info

    - name: Execute Tests
      shell: bash
      run: |
        bazelisk test //... 

    - name: Build Anything Not Tested
      shell: bash
      run: |
        bazelisk build //... 

    - name: Test Simple Example
      shell: bash
      run: |
        cd examples/simple
        bazelisk test //... --verbose_failures --sandbox_debug

    - name: Test Package With Shared Deps Example
      shell: bash
      run: |
        cd examples/package_with_shared_deps
        bazelisk test //...

    - name: Test Vapor Example
      shell: bash
      run: |
        cd examples/vapor
        bazelisk test //...
