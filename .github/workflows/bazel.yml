name: Build

on:
  pull_request:
    branches: [ main ]

jobs:
  macos_build:

    runs-on: macos-11.0

    steps:
    - uses: actions/checkout@v2

    - name: Write local.bazelrc File
      shell: bash
      run: |
        cat >local.bazelrc <<EOF
        common --config=ci
        EOF

    - name: Output the Bazel Info
      shell: bash
      run: |
        bazelisk info

    - name: Execute Tests
      shell: bash
      run: |
        bazelisk test //... 

    - name: Build Anything Not Tested
      shell: bash
      run: |
        bazelisk build //... 

    - name: Test Simple Example with Default Xcode
      shell: bash
      run: |
        cd examples/simple
        bazelisk test //...

    # GH088: Enable this test once the CI test failure is addressed.
    #
    # - name: Test Simple Example, Build with Older Xcode
    #   shell: bash
    #   run: |
    #     cd examples/simple
    #     # Make sure that we are starting clean; seeing weird failures.
    #     bazelisk clean --expunge
    #     # Default Xcode has SPM 5.4 or later; build with Xcode that has SPM
    #     # less than 5.4.
    #     bazelisk test --xcode_version_config=//:host_xcodes //...

    - name: Test Simple Example, Default Xcode is Incompatible, Use DEVELOPER_DIR
      shell: bash
      run: |
        cd examples/simple
        current_xcode=$(xcode-select --print-path)
        echo "current_xcode: ${current_xcode}"
        # Switch default Xcode to SPM 5.3.
        sudo xcode-select --switch /Applications/Xcode_12.4.app
        # Use DEVELOPER_DIR to specify the current Xcode
        export DEVELOPER_DIR="${current_xcode}"
        bazelisk test //...
        sudo xcode-select --switch "${current_xcode}"

    - name: Test Simple Example, Default Xcode is Incompatible, Use env attribute to set DEVELOPER_DIR
      shell: bash
      run: |
        cd examples/simple_with_dev_dir
        current_xcode=$(xcode-select --print-path)
        # Switch default Xcode to SPM 5.3.
        sudo xcode-select --switch /Applications/Xcode_12.4.app
        # The DEVELOPER_DIR value is specified as an env attribute on spm_repositories.
        bazelisk test //...
        sudo xcode-select --switch "${current_xcode}"

    - name: Test Simple Example Using Revision
      shell: bash
      run: |
        cd examples/simple_revision
        bazelisk test //...

    - name: Test Simple with External Binary Example
      shell: bash
      run: |
        cd examples/simple_with_binary
        bazelisk test //...

    - name: Test Local Package Example
      shell: bash
      run: |
        cd examples/local_package
        bazelisk test //...

    - name: Test Vapor Example
      shell: bash
      run: |
        cd examples/vapor
        bazelisk test //...

    - name: Test iOS Simulator Example
      shell: bash
      run: |
        cd examples/ios_sim
        bazelisk test //...

  ubuntu_build:

    runs-on: ubuntu-20.04

    env:
      CC: clang

    steps:
    - uses: actions/checkout@v2


    - name: Write local.bazelrc File
      shell: bash
      run: |
        cat >local.bazelrc <<EOF
        common --config=ci
        EOF

    - name: Bazel Config for Linux
      shell: bash
      run: |
        # Make sure that the Swift bin directory is first in the PATH. This addresses
        # the `invalid linker name in argument '-fuse-ld=gold'` error when running
        # SPM. In short, it allows SPM to find the correct linker.
        swift_exec=$(which swift)
        real_swift_exec=$(realpath $swift_exec)
        real_swift_dir=$(dirname $real_swift_exec)
        new_path="${real_swift_dir}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        cat >>local.bazelrc <<EOF
        build --action_env=PATH=${new_path}
        EOF

    - name: Output the Bazel Info
      shell: bash
      run: |
        bazelisk info

    - name: Execute Tests
      shell: bash
      run: |
        bazelisk test //... 

    - name: Build Anything Not Tested
      shell: bash
      run: |
        bazelisk build //... 

    - name: Test Simple Example
      shell: bash
      run: |
        cd examples/simple
        bazelisk test //...

    - name: Test Simple Example Using Revision
      shell: bash
      run: |
        cd examples/simple_revision
        bazelisk test //...

    - name: Test Local Package Example
      shell: bash
      run: |
        cd examples/local_package
        bazelisk test //...


    - name: Test Vapor Example
      shell: bash
      run: |
        cd examples/vapor
        bazelisk test //...
